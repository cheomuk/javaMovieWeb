<!DOCTYPE html>
<html>
<head>

	<!-- 문자 인코딩 방식을 UTF-8로 설정 -->
	<meta charset="UTF-8">
	
	<!-- 반응형 웹 뷰포트 설정 -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<!-- 웹페이지 제목 설정 -->
	<title>H&Js 영화 리뷰</title>
	
	<!-- css 적용 -->
	<link rel="stylesheet" href="MovieReviewStyle.css"/>

	<!--부트스트랩 CSS 양식 적용(모달 창 출력에만 이용될 에정)-->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">

</head>

<body>

	<!--영화 검색 바 부분-->
	<header>
        <form  id="form">
            <input type="text" placeholder="Search" id="search" class="search">
        </form>
    </header>

	<!-- 페이지 소개 부분-->
	<div class="pagepresentation">
		<h1>H&Js 영화 리뷰(가제)</h1>
		<p>좋아하는 영화에 인상적인 리뷰를 남겨보세요</p>
	</div>

	<!--영화 장르 태그 부분-->
	<div id="tags"></div>
	
	<!--영화 내용 출력 부분-->
	<main id="main"></main>

	<!--페이지 변경 부분-->
	<div class="pagecontrol">

		<!--이전 페이지로 이동-->
        <div class="page" id="prev">Previous Page</div>

		<!--현재 페이지 출력-->
        <div class="current" id="current">1</div>

		<!--다음 페이지로 이동-->
        <div class="page" id="next">Next Page</div>

    </div>
	

	
	
	
	<!-- 영화 리뷰 모달(팝업)-->
	<div class="modal" id="review_modal" tabindex="-1">

		<!--모달 대화창 전체-->
		<div class="modal-dialog">

			<!--모달 컨텐츠 부분-->
			<div class="modal-content">

				<!--모달의 header 부분-->
				<div class="modal-header">

					<!--모달의 제목 부분에 "후기" 텍스트 출력-->
					<h3 class="modal-title">후기</h3>

					<!--모달 닫기 버튼 출력-->
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>

				<!--모달의 body 부분-->
				<div class="modal-body">
					<!--모달 안에 출력할 리뷰 내용(자바스크립트를 통해 구현)-->
				</div>

				<!--모달의 footer 부분-->
				<div class="modal-footer">
					<input type="text" class="form-control" id="review" style="width:70%">
				  <button type="button" class="btn btn-primary" onclick="addReview()">후기 쓰기</button>
				</div>
			</div>
		</div>
	</div>


	<!--  제이 쿼리 및 부트스트랩 사용 선언-->
	

	<script src="MovieReview.js"></script>

	<script>
		// target_movie 변수 선언
		let target_movie = 0;

		//제이쿼리 시작
		$(document).ready(function(){
	
			//ajax 함수를 통해 서버와 데이터를 주고 받음
			$.ajax({
	
				// 클라이언트가 요청을 보낼 서버의 URL 주소(우리는 themoviedb로부터 받아옴)
				url: "https://api.themoviedb.org/3/movie/popular?api_key=36d5680bfd986459259d1678be4f518e&page=1",
				
				// HTTP 요청과 함께 서버로 보낼 데이터 POST 방식에서만 사용
				data: {}, 
	
				// HTTP 요청 방식(GET, POST)
				type: "GET", 
	
				//응답이 성공상태일때 호출되는 함수, json이라는 데이터를 받아옴
				success:function(getmovie){
	
					// Console에서 입력한 값들을 확인하기 위해 넣어둠.
					// callback 함수이기도 함.
					console.log(getmovie)   
					
					// .html()은 선택한 요소 안의 내용을 가져오거나 다른 내용으로 바꿈
					// movie-list 라는 id를 가진 태그를 찾아 내부 내용을 모두 지움
					$(".movie-list").html('')
	
					//이미지 호스트의 주소를 저장할 image_host 변수 선언
					let image_host = "https://image.tmdb.org/t/p/w500/"
	
					//요청의 응답으로 받아온 값을 저장할 movie_list 변수 
					let movie_list = getmovie.results;
	
					// 응답으로 받아온 데이터의 수만큼 반복
					for(let i=0; i<movie_list.length; i++){
	
						//movie-list id를 가진 태그에 추가될 내용을 저장할 card 변수 선언
						let card = 
						`<div class="col-sm" style="margin-top:10px;border:none">
							<div class="card" style="width: 18rem;">
								<img src="${image_host + '' + movie_list[i].poster_path }" class="card-img-top" alt="...">
								<div class="card-body">
								<h5 class="card-title">${movie_list[i].title}</h5>

								<a href="#!" class="btn btn-success" style="width:100%" onclick=review(${movie_list[i].id})>후기 보기</a>

								</div>
							</div>
						</div>
						`
	
						// movie-list 라는 id를 가진 태그를 찾아 card 변수 안에 저장된 값들을 아래에 추가함
						// 즉, 가져온 영화 리스트의 개수만큼 영화 카드가 만들어진다
						$(".movie-list").append(card)
					}
				},
				error:function(err){
	
				}
			}) //에이잭스 끝
		}) //제이쿼리 끝

		//id라는 매개변수를 가지는 review 함수 선언
		function review(id){
	
			// 매개변수로 받아온 값을 target_movie 변수에 대입
			target_movie = id;
	
			//modal-body라는 id를 가진 태그를 찾아 내부 내용을 모두 지움
			//modal-body id를 가진 태그는 팝업창과 관련된 태그
			$(".modal-body").html('')
	
			//ajax 함수를 통해 서버와 데이터를 주고 받음
			$.ajax({
	
				// 클라이언트가 요청을 보낼 서버의 URL 주소
				url: `/review/read?movie_id=${target_movie}`, 
	
				// HTTP 요청과 함께 서버로 보낼 데이터 POST 방식에서만 사용
				data: {}, 
	
				// HTTP 요청 방식(GET, POST)
				type: "GET", 
	
				// 응답이 성공상태일때 호출되는 함수, json이라는 데이터를 받아옴
				success:function(json){

				  	// 받아온 데이터를 저장할 reviews 변수
				  	let reviews = json.data;
	
				  	// 리뷰의 개수만큼 반복 
				  	for(let i=0; i<reviews.length; i++){
					
					// 받아온 리뷰를 modal-body id를 가진 태그에 추가
					// 즉, 리뷰의 개수만큼 리뷰를 출력해준다는 이야기
					$(".modal-body").append(`<p>${reviews[i].review}</p>`)
					}
				},
				error:function(e){
	
				}
			}) // 에이잭스 끝
	
			//review_modal에 해당하는 모달 창을 호출한다.
			$("#review_modal").modal('show')
	
		} // review 함수 끝
	
		// 리뷰를 추가하는 기능을 가진 addreview 함수 
		function addReview(){
			let review = $("#review").val();
			let review_html = `<p>${review}</p>`
			$.ajax({
				url: `/review/create`,
	
				data: {
					movie_id:target_movie,
					review:review
				},	// HTTP 요청과 함께 서버로 보낼 데이터 POST 방식에서만 사용
				type: "POST", // HTTP 요청 방식(GET, POST)
				success:function(json){

				},
				error:function(e){
	
				}
			})
			$(".modal-body").append(review_html)
			$("#review").val('')
		}
	</script>
</body>
</html>